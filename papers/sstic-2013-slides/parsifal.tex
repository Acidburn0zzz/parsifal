\documentclass{beamer}
\useoutertheme{infolines}
\usepackage[french]{babel}
\usepackage[latin1]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{listings}
\usepackage{array}
\lstset{language=Caml, basicstyle=\footnotesize,
  morekeywords={enum, alias, struct, union,
                asn1_alias, asn1_union, asn1_struct,
                UnknownVal, with_lwt, Exception}}


\title[https://github.com/ANSSI-FR/parsifal]{Parsifal, ou comment écrire rapidement des \emph{parsers}
  robustes et efficaces}
\author{Olivier Levillain}
%\institution{ANSSI / Télécom SudParis}
\date{5 juin 2013}

\begin{document}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}
  \maketitle
\end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}{Contexte}
  \begin{itemize}
  \item Pour comprendre un format ou un protocole, le mieux est de
    l'implémenter\\[.5cm]

  \item Comme souvent, le diable se cache dans les détails
    \begin{itemize}
    \item encodage des entiers en ASN.1 ou en protobuf
    \item \textit{endianness} des champs, jusqu'à l'ordre de
      remplissage d'un octet bit-à-bit
    \item sémantique des protocoles et spécifications floues\\[.5cm]
    \end{itemize}

  \item Les \textit{parser} binaires sont une brique de base de toute
    implémentation
  \item En 2012, quelques vulnérabilités liées à des \textit{parsers}
    \begin{itemize}
    \item \texttt{libpng}: CVE-2011-3045 et CVE-2011-3026 %\TODO{2011 à changer!}
    \item \texttt{libtiff}: CVE-2012-5581, CVE-2012-4447 et CVE-2012-1173
    \item \texttt{wireshark}: CVE-2012-4048, CVE-2012-4296...
    \end{itemize}
  \end{itemize}
\end{frame}


\begin{frame}{Outils existants pour analyser des formats binaires}
  \begin{itemize}
  \item Wireshark
  \item Scapy\\[.5cm]

  \item Avantages
    \begin{itemize}
    \item outils existants
    \item de nombreux protocoles réseau déjà implémentés
    \item Scapy très facilement extensible\\[.5cm]
    \end{itemize}

  \item Limitations
    \begin{itemize}
    \item outils limités au réseau
    \item Wireshark difficile à étendre
    \item lenteur du python
    \end{itemize}
  \end{itemize}
\end{frame}


\begin{frame}{Cas réel: analyse de données SSL}
  \begin{itemize}
  \item Analyse de mesures SSL (article publié à ACSAC 2012)
    \begin{itemize}
    \item pour chaque hôte contacté, réponse du serveur à un
      \texttt{ClientHello} TLS sur le port 443
    \item 140~Go de données brutes\\[.5cm]
    \end{itemize}

  \item Problème pour disséquer toutes ces données
    \begin{itemize}
    \item données corrompues
    \item protocole autre que SSL/TLS (en général HTTP ou SSH)
    \item erreurs plus subtiles dans les messages\\[.5cm]
    \end{itemize}
  \end{itemize}
\end{frame}


\begin{frame}{Interlude concernant SSL}
  Que répond un serveur si vous lui proposez les suites crypto
  \texttt{AES128-SHA} et \texttt{DHE-RSA-AES128-SHA}?
  \begin{enumerate}
  \item<2->[A] \texttt{AES128-SHA}
  \item<3->[B] \texttt{DHE-RSA-AES128-SHA}
  \item<4->[C] une alerte
  \item<5->[D] la réponse D (\texttt{RC4\_MD5})
  \end{enumerate}
\end{frame}


\begin{frame}{Historique des outils}
  Pour traiter ce volume de données, plusieurs \textit{parsers} TLS
  ont été développés
  \begin{itemize}
  \item Python: rapide à écrire, mais lent à l'exécution\\[.5cm]
  \item C++ (avec \textit{templates} et des objets): flexible, rapide,
    mais verbeux et pénible à mettre au point\\[.5cm]
  \item OCaml avec un préprocesseur: concis, rapide, flexible et
    robuste
  \end{itemize}
\end{frame}


\begin{frame}{Parsifal: plaquette publicitaire}
  \begin{itemize}
  \item \'Ecriture de \textit{parsers} grâce à du code \textbf{concis}
  \item \textbf{Efficacité} des programmes produits
  \item \textbf{Robustesse} des outils développés
  \item Méthodologie de développement adaptée à l'écriture
    \textbf{incrémentale} de \textit{parsers} flexibles\\[.5cm]

  \item<2-> Parsifal permet aussi de \emph{dumper} les objets décrits
  \item<2-> Exemple: client DNS en 200~lignes\\[.5cm]

  \item<3-> Objectifs de Parsifal
    \begin{itemize}
    \item outils d'analyse maîtrisés
    \item brique de base pour des outils de dépollution
    \end{itemize}
  \end{itemize}
\end{frame}


\begin{frame}[fragile]{Exemple: structure d'une image PNG (1/3)}

  \begin{lstlisting}
struct png_file = {
  png_magic : magic("\x89\x50\x4e\x47\x0d\x0a\x1a\x0a");
  png_content : binstring;
}
  \end{lstlisting}

  \pause
  \begin{lstlisting}
let input = input_of_filename "sstic.png" in
let png = parse_png_file input in
print_value (value_of_png_file png)
  \end{lstlisting}

  \medskip
  \pause

  Démo: notre premier \textit{parser} PNG

\end{frame}


\begin{frame}[fragile]{Exemple: structure d'une image PNG (2/3)}

  \begin{lstlisting}
struct png_file = {
  png_magic : magic("\x89\x50\x4e\x47\x0d\x0a\x1a\x0a");
  chunks : list of png_chunk;
}
  \end{lstlisting}

\pause

  \begin{lstlisting}
struct png_chunk = {
  chunk_size : uint32;
  chunk_type : string(4);
  data : binstring(chunk_size);
  crc : uint32;
}
  \end{lstlisting}

  \medskip
  \pause

  Démo: résultat du préprocesseur

\end{frame}


\begin{frame}[fragile]{Exemple: structure d'une image PNG (2/3)}

  \begin{lstlisting}
struct png_chunk = {
  chunk_size : uint32;
  chunk_type : string(4);
  data : container(chunk_size) of chunk_content(chunk_type);
  crc : uint32;
}
  \end{lstlisting}

\pause

  \begin{lstlisting}
union chunk_content [enrich] (UnparsedChunkContent) =
| "IHDR" -> ImageHeader of image_header
| "IDAT" -> ImageData of binstring
| "IEND" -> ImageEnd
| "PLTE" -> ImagePalette of list of array(3) of uint8

struct image_header = {
  ...
}
  \end{lstlisting}

  \medskip
  \pause

  Démo: \textit{parser} enrichi.

\end{frame}



\begin{frame}{Parsifal: présent...}

  Fonctionnalités non présentées
  \begin{itemize}
  \item Conteneurs (base64, zlib, etc.)
  \item Manipulation simple des objets
    \begin{itemize}
    \item \texttt{x509show -g "**.extnID" cert.pem}
    \end{itemize}
  \end{itemize}

  \medskip

  Formats implémentés:
  \begin{center}
    \begin{tabular}{|l|l|}
      \hline
      X.509 & description assez complète \\
      \hline
      SSL/TLS & beaucoup de messages décrits \\
      \hline
      PE & code à intégrer \\
      \hline
      Kerberos & messages PKINIT à intégrer \\
      \hline
      TAR & tutoriel \\
      \hline
      DNS & tutoriel + \texttt{picodig} \\
      \hline
      PNG & tutoriel + stage en cours \\
      \hline
      PCAP & support rudimentaire PCAP/IP/TCP/UDP \\
      \hline
    \end{tabular}
  \end{center}
\end{frame}

\begin{frame}{Parsifal:... et futur}
  \begin{itemize}
  \item Stabilisation v0.2 en cours\\[.5cm]

  \item Consolider la documentation\\[.5cm]

  \item Perspectives
    \begin{itemize}
    \item assainissement PDF
    \item animation des protocoles (TLS)
    \end{itemize}
  \end{itemize}
\end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}{Questions ?}
  \vspace*{\stretch{1}}

  \begin{center}
    Merci de votre attention.

    \vspace*{\stretch{3}}

    \begin{minipage}[c]{.49\linewidth}
      \vspace*{\stretch{1}}
      \begin{center}
        \includegraphics[width=.85\linewidth]{github}
      \end{center}
      \vspace*{\stretch{1}}
    \end{minipage}
    \begin{minipage}[c]{.49\linewidth}
      \vspace*{\stretch{1}}
      \begin{center}
        \includegraphics[width=.5\linewidth]{ocaml}
      \end{center}
      \vspace*{\stretch{1}}
    \end{minipage}

    \vspace*{\stretch{1}}

    \url{https://github.com/ANSSI-FR/parsifal}
  \end{center}

  \vspace*{\stretch{1}}
\end{frame}

\end{document}
